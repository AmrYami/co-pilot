namespace: "dw::common"

cases:
  - id: c001
    question: "list all contracts where CONTRACT_STATUS = expire"
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'WHERE'
      - 'CONTRACT_STATUS'
    expect_sql_not_contains:
      - 'BETWEEN :date_start AND :date_end'

  - id: c002
    question: "top 10 contracts by contract value last month"
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'START_DATE <= :date_end'
      - 'END_DATE >= :date_start'
      - 'ORDER BY NVL(CONTRACT_VALUE_NET_OF_VAT,0) DESC'
      - 'FETCH FIRST :top_n ROWS ONLY'
    require_binds: [date_start, date_end, top_n]

  - id: c003
    question: "top 10 contracts by contract value last 8 months"
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'START_DATE <= :date_end'
      - 'END_DATE >= :date_start'
      - 'ORDER BY NVL(CONTRACT_VALUE_NET_OF_VAT,0) DESC'
      - 'FETCH FIRST :top_n ROWS ONLY'
    require_binds: [date_start, date_end, top_n]

  - id: c004
    question: "contracts expiring in 30 days (count)"
    expect_sql_contains:
      - 'SELECT COUNT(*)'
      - 'FROM "Contract"'
      - 'END_DATE BETWEEN :date_start AND :date_end'
    require_binds: [date_start, date_end]

  - id: c005
    question: "List all contracts requested last month (contract id, owner, request date)."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'REQUEST_DATE BETWEEN :date_start AND :date_end'
      - 'ORDER BY REQUEST_DATE DESC'
    require_binds: [date_start, date_end]

  - id: c006
    question: "Top 20 contracts by gross contract value last month"
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'START_DATE <= :date_end'
      - 'END_DATE >= :date_start'
      - 'ORDER BY NVL(CONTRACT_VALUE_NET_OF_VAT,0) + CASE WHEN NVL(VAT,0) BETWEEN 0 AND 1'
      - 'FETCH FIRST :top_n ROWS ONLY'
    require_binds: [date_start, date_end, top_n]

  - id: c007
    question: "Total gross value of contracts per owner department last quarter"
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'GROUP BY OWNER_DEPARTMENT'
      - 'SUM(NVL(CONTRACT_VALUE_NET_OF_VAT,0) + CASE WHEN NVL(VAT,0) BETWEEN 0 AND 1'
      - 'START_DATE <= :date_end'
      - 'END_DATE >= :date_start'
    require_binds: [date_start, date_end]

  - id: c008
    question: "Total gross value of contracts per owner department"
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'GROUP BY OWNER_DEPARTMENT'
      - 'SUM(NVL(CONTRACT_VALUE_NET_OF_VAT,0) + CASE WHEN NVL(VAT,0) BETWEEN 0 AND 1'

  - id: c009
    question: "Count of contracts by status (all time)"
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'CONTRACT_STATUS AS GROUP_KEY'
      - 'COUNT(*) AS CNT'
      - 'GROUP BY CONTRACT_STATUS'
    expect_sql_not_contains:
      - 'BETWEEN :date_start AND :date_end'

  - id: c010
    question: "Contracts with END_DATE in the next 90 days."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'END_DATE BETWEEN :date_start AND :date_end'
    require_binds: [date_start, date_end]

  - id: c011
    question: "Contracts where VAT is null or zero but CONTRACT Value > 0."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'NVL(VAT, 0) = 0'
      - 'NVL(CONTRACT_VALUE_NET_OF_VAT,0) > 0'

  - id: c012
    question: "Show contracts where REQUEST TYPE = Renewal in 2023."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'REQUEST_DATE BETWEEN :date_start AND :date_end'
      - 'REQUEST_TYPE'
    require_binds: [date_start, date_end]

  - id: c013
    question: "List distinct ENTITY values and their contract counts."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'ENTITY AS GROUP_KEY'
      - 'COUNT(*) AS CNT'
      - 'GROUP BY ENTITY'

  - id: c014
    question: "list contracts owneres department."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'OWNER_DEPARTMENT AS GROUP_KEY'
      - 'SUM(NVL(CONTRACT_VALUE_NET_OF_VAT,0)) AS MEASURE'
      - 'GROUP BY OWNER_DEPARTMENT'

  - id: c015
    question: "Contracts missing CONTRACT_ID (data quality check)."
    expect_sql_contains:
      - 'FROM "Contract"'
      - '(CONTRACT_ID IS NULL OR TRIM(CONTRACT_ID) = '')'

  - id: c016
    question: "For the last 90 days, total gross by stakeholder (across 1..8 slots)."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'CONTRACT_STAKEHOLDER_1'
      - 'SUM(NVL(CONTRACT_VALUE_NET_OF_VAT,0) + CASE WHEN NVL(VAT,0) BETWEEN 0 AND 1'
      - 'GROUP BY'
    require_binds: [date_start, date_end]

  - id: c017
    question: "For 2024 YTD, top 5 contracts by gross."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'ORDER BY NVL(CONTRACT_VALUE_NET_OF_VAT,0) + CASE WHEN NVL(VAT,0) BETWEEN 0 AND 1'
      - 'FETCH FIRST :top_n ROWS ONLY'
    require_binds: [date_start, date_end, top_n]

  - id: c018
    question: "Average gross per REQUEST_TYPE in the last 6 months."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'GROUP BY REQUEST_TYPE'
      - 'AVG('
    require_binds: [date_start, date_end]

  - id: c019
    question: "Monthly trend (last 12 months) of active contracts (by REQUEST_DATE)."
    expect_sql_contains:
      - 'FROM "Contract"'
      - "TRUNC(REQUEST_DATE,'MM')"
      - "GROUP BY TRUNC(REQUEST_DATE,'MM')"
    require_binds: [date_start, date_end]

  - id: c020
    question: "For ENTITY_NO = 'E-123', total and count by CONTRACT_STATUS."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'ENTITY_NO'
      - 'CONTRACT_STATUS'
      - 'GROUP BY CONTRACT_STATUS'

  - id: c021
    question: "Contracts expiring in 30/60/90 days (three separate counts)."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'END_DATE BETWEEN :date_start AND :date_end'

  - id: c022
    question: "Owner department with the highest average gross last quarter."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'GROUP BY OWNER_DEPARTMENT'
      - 'AVG('
      - 'FETCH FIRST 1 ROWS ONLY'

  - id: c023
    question: "Stakeholders involved in more than N contracts in 2024."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'CONTRACT_STAKEHOLDER_1'
      - 'GROUP BY CONTRACT_STAKEHOLDER_1'
      - 'HAVING COUNT(*)'
    require_binds: [date_start, date_end]

  - id: c024
    question: "Contracts where representative_email is missing."
    expect_sql_contains:
      - 'FROM "Contract"'
      - '(representative_email IS NULL OR TRIM(representative_email) = '')'

  - id: c025
    question: "For REQUESTER = 'john@corp', total gross & count by quarter."
    expect_sql_contains:
      - 'FROM "Contract"'
      - "TRUNC(REQUEST_DATE,'Q')"
      - 'GROUP BY TRUNC(REQUEST_DATE,'
      - 'REQUESTER'

  - id: c026
    question: "For each stakeholder, list distinct departments they touched in 2024, total gross, and contract count (one row per stakeholder)."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'CONTRACT_STAKEHOLDER_1'
      - 'LISTAGG'
      - 'GROUP BY CONTRACT_STAKEHOLDER_1'
    require_binds: [date_start, date_end]

  - id: c027
    question: "Top 10 contracts pairs by gross in the last 180 days."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'ORDER BY'
      - 'FETCH FIRST :top_n ROWS ONLY'
    require_binds: [date_start, date_end, top_n]

  - id: c028
    question: "Detect duplicate contract ids (same CONTRACT_ID across rows)."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'GROUP BY CONTRACT_ID'
      - 'HAVING COUNT(*) > 1'

  - id: c029
    question: "Median gross value of contracts per owner department this year."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'MEDIAN('
      - 'GROUP BY OWNER_DEPARTMENT'

  - id: c030
    question: "Contracts where END_DATE < START_DATE (integrity check)."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'WHERE END_DATE < START_DATE'

  - id: c031
    question: "Contracts with DURATION like \"12 months\" but actual END_DATE–START_DATE != ~12 months."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'DURATION'
      - 'MONTHS_BETWEEN('

  - id: c032
    question: "Year-over-year comparison of gross total for the same period (e.g., this Jan–Mar vs last Jan–Mar)."
    expect_sql_contains:
      - 'FROM "Contract"'
      - "TRUNC(REQUEST_DATE,'YY')"
      - 'SUM('

  - id: c033
    question: "For CONTRACT_STATUS in ('Active','Pending'), list contracts whose total gross exceeds a threshold (e.g., > 1,000,000)."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'CONTRACT_STATUS'
      - 'NVL(CONTRACT_VALUE_NET_OF_VAT,0)'
      - '>'
      - 'ORDER BY'

  - id: c034
    question: "For each ENTITY, top 3 contracts by gross in last 365 days."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'ROW_NUMBER() OVER (PARTITION BY ENTITY ORDER BY'
      - 'WHERE'
    require_binds: [date_start, date_end]

  - id: c035
    question: "OWNER_DEPARTMENT vs DEPARTMENT_OUL comparison (where OUL is the lead); list any cases."
    expect_sql_contains:
      - 'FROM "Contract"'
      - 'WHERE OWNER_DEPARTMENT <> DEPARTMENT_OUL'
